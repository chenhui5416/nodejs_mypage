JS闭包-作用域-垃圾回收机制
-----------------------------

###闭包

>闭包的定义：是指有权访问 另一个函数 作用域的 变量的 函数

首先看一个例子：
	
	function outer {
		var n = 1;
		function inner (){
			console.log(n++);
		}
		return inner;
	}
	var res = outer();   //返回内部函数 f2
	res();               //输出 1 
	console.log(n);      //输出undefined
	res();               //输出2

分析代码如下：
>函数 outer 调用返回值为内部函数 inner ，并赋值给 res。res() 执行输出 n 并 n++ 。函数inner的作用域在inner定义的时候就已经确定，所以inner运行时，会根据作用域链查找离自己最近的值，而outer中的内部变量 n 可以被inner访问到，且是作用域中最近的值，所以调用 n 。

>而 n 的值为什么储存呢？为什么每次输出n是基于上一次执行的结果？  
这和js的垃圾回收机制有关（后面详细说），大致就是outer运行时将内部函数inner赋值给了全局变量res，inner 又引用到了outer的内部变量 n ，所以当res 不消亡时，n也不会消亡，进而被保存。

###作用域链 and 闭包

>作用域含义：简单的说，作用域链就是在函数定义的时候创建的，用来需找使用到的变量的值的一个索引（是索引，不是拷贝！），而他的内部规则是把函数内定义变量放在最前，以此类推。当函数要查询某个变量的值时，JS解释器就会在作用域链上查找，从前往后，知道找到位置，或者undefined。

再来一个例子，上面的变种，用来理解作用域

	var n = 1;
	function outer {
		var n = 1999;
		function inner (){
			console.log(n++);
		}
		return inner;
	}
	
	var res = outer();   //返回内部函数 f2
	res();            //输出 1999 
	console.log(n);   //输出 1
	res();            //输出 2000

分析如下：

>作用域： 
当定义函数（inner）的时候，JS解释器会将函数（inner）的作用域链（scope chain）设置为定义函数（inner）时所在的环境。
（也就是说某个函数能够访问到的变量在函数定义时决定，不是在函数执行时）

>新执行一个 ``var ress = outer(); ress();``会影响res的输出不？
不会，新定义的ress 类似于一个新的 inner副本，这时候的outer 也是新的，他的n与 原来的n不共享的。

###闭包什么时候用

1. 保护函数内部的变量安全，函数内部的值只能是闭包函数能访问到，类似于定义私有变量的公有访问值。
2. 在内存中维持一个变量， 如上说的，闭包会导致局部变量不被回收，所以可以利用闭包函数来维持一个变量。
3. 实现js私有属性和方法，类是一

###javascript内存回收机制

js的内存回收机制和java的回收机制很像，就是借鉴了java的内存回收机制。

一个函数在执行的开始的时候，会给其中定义的变量划分内存空间保存，以便后面的语句使用到，等到函数执行完毕后，这些变量就被认为没有用了，对应的内存空间就会被回收，下一次执行时，就重新赋值回到初始状态。

但是如果这个函数（outer）内部又嵌套了一个函数（inner），而内部函数（inner）被包裹本身的外部函数（outer）之外的函数调用，这时上面的机制就要改变。假如外部函数（outer）运行结束后，就把它的内部变量空间内存回收，这时外部要是调用了内部函数（inner）就会出现无法读取到内部变量的值。（有点绕，参考例一）

所以JS解释器在遇到函数定义（用函数调用，或者赋值更准）的时候，会自动的把函数和他可能适用到的变量（所有），一起保存起来，也就构建了一个闭包，这些变量不会被回收，只有当内部函数不可能被调用以后，才销毁这个闭包，而没有任何一个闭包引用的变量才会被下一次的内存回收机制回收。

>内存回收根据浏览器不同机制不同，有一种就是按照阈值进行回收，达到某个阈值后，内存回收机制就开启回收那些没有被引用的变量。

>两种会后机制：标记清楚 和 引用清楚（若带循环引用，这个方法就无力了，ie8-使用）

>内存优化方法：不会再使用某个变量的时候，就直接 赋值 null ，这样就保证下一次肯定会被回收。

>正如上面说的，闭包会导致变量不被回收，而很多浏览器的运行空间是有限的，所以容易导致内存出错或者导致运行变慢！所以使用闭包要注意

#####注：以上部分内容来自网络，由于当时用笔记记得，所以忘了链接，若有作者看到，需要指明出处，请联系我。

转载注明出处：chenhui5416.duapp.com
